// Copyright 2021 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package aaaaxy

import (
	"math"
)

type palData struct {
	size     int
	colors   []float32
	minDelta float64
}

func newPalData(minDelta float64, c []float32) *palData {
	n := len(c) / 3
	for i := 0; i < n; i++ {
		if i >= 16 {
			// Protect only colors 0 to 15 from bad dithering.
			continue
		}
		for j := i + 1; j < n; j++ {
			delta := 0.0
			for k := 0; k < 3; k++ {
				d := math.Abs(float64(c[3*i+k]) - float64(c[3*j+k]))
				if d > delta {
					delta = d
				}
			}
			/*
				if delta < minDelta-0.001 {
					log.Warningf("likely color confusion: %d %d -> %v < %v", i, j, delta, minDelta)
				}
			*/
		}
	}
	return &palData{
		size:     n,
		colors:   c,
		minDelta: minDelta,
	}
}

var palettes = map[string]*palData{
	// Monochrome.
	"mono": newPalData(1, []float32{
		0, 0, 0,
		1, 1, 1,
	}),

	// The original IBM CGA palette.
	"cga40l": newPalData(2/3.0, []float32{
		0, 0, 0,
		0, 2 / 3.0, 0,
		2 / 3.0, 0, 0,
		2 / 3.0, 1 / 3.0, 0,
	}),

	// The original IBM CGA palette at high intensity.
	"cga40h": newPalData(2/3.0, []float32{
		0, 0, 0,
		1 / 3.0, 1, 1 / 3.0,
		1, 1 / 3.0, 1 / 3.0,
		1, 1, 1 / 3.0,
	}),

	// The original IBM CGA palette on NTSC.
	// curl https://upload.wikimedia.org/wikipedia/commons/7/7c/CGA_CompVsRGB_320p0.png | convert PNG:- -crop 100x180+500+10 -compress none PNM:- | tail -n +4 | uniq | awk '{ print $1 "/255.0, " $2 "/255.0, " $3 "/255.0,"; }'
	"cga40n": newPalData(1/3.0, []float32{
		0 / 255.0, 0 / 255.0, 0 / 255.0,
		0 / 255.0, 113 / 255.0, 209 / 255.0,
		0 / 255.0, 25 / 255.0, 172 / 255.0,
		0 / 255.0, 113 / 255.0, 241 / 255.0,
		149 / 255.0, 79 / 255.0, 0 / 255.0,
		109 / 255.0, 212 / 255.0, 65 / 255.0,
		162 / 255.0, 123 / 255.0, 28 / 255.0,
		116 / 255.0, 212 / 255.0, 97 / 255.0,
		184 / 255.0, 33 / 255.0, 0 / 255.0,
		144 / 255.0, 166 / 255.0, 156 / 255.0,
		197 / 255.0, 78 / 255.0, 118 / 255.0,
		151 / 255.0, 166 / 255.0, 187 / 255.0,
		243 / 255.0, 104 / 255.0, 0 / 255.0,
		203 / 255.0, 237 / 255.0, 38 / 255.0,
		255 / 255.0, 149 / 255.0, 1 / 255.0,
		210 / 255.0, 237 / 255.0, 70 / 255.0,
	}),

	// The alternate IBM CGA palette.
	"cga41l": newPalData(2/3.0, []float32{
		0, 0, 0,
		0, 2 / 3.0, 2 / 3.0,
		2 / 3.0, 0, 2 / 3.0,
		2 / 3.0, 2 / 3.0, 2 / 3.0,
	}),

	// The alternate IBM CGA palette at high intensity.
	"cga41h": newPalData(2/3.0, []float32{
		0, 0, 0,
		1 / 3.0, 1, 1,
		1, 1 / 3.0, 1,
		1, 1, 1,
	}),

	// The alternate IBM CGA palette on NTSC.
	// curl https://upload.wikimedia.org/wikipedia/commons/c/c5/CGA_CompVsRGB_320p1.png | convert PNG:- -crop 100x180+500+10 -compress none PNM:- | tail -n +4 | uniq | awk '{ print $1 "/255.0, " $2 "/255.0, " $3 "/255.0,"; }'
	"cga41n": newPalData(1/3.0, []float32{
		0 / 255.0, 0 / 255.0, 0 / 255.0,
		0 / 255.0, 154 / 255.0, 255 / 255.0,
		0 / 255.0, 66 / 255.0, 255 / 255.0,
		0 / 255.0, 144 / 255.0, 255 / 255.0,
		170 / 255.0, 76 / 255.0, 0 / 255.0,
		132 / 255.0, 250 / 255.0, 210 / 255.0,
		185 / 255.0, 162 / 255.0, 173 / 255.0,
		150 / 255.0, 240 / 255.0, 255 / 255.0,
		205 / 255.0, 31 / 255.0, 0 / 255.0,
		167 / 255.0, 205 / 255.0, 255 / 255.0,
		220 / 255.0, 117 / 255.0, 255 / 255.0,
		185 / 255.0, 195 / 255.0, 255 / 255.0,
		255 / 255.0, 92 / 255.0, 0 / 255.0,
		237 / 255.0, 255 / 255.0, 204 / 255.0,
		255 / 255.0, 178 / 255.0, 166 / 255.0,
		255 / 255.0, 255 / 255.0, 255 / 255.0,
	}),

	// The "monochrome" IBM CGA palette.
	"cga5l": newPalData(2/3.0, []float32{
		0, 0, 0,
		0, 2 / 3.0, 2 / 3.0,
		2 / 3.0, 0, 0,
		2 / 3.0, 2 / 3.0, 2 / 3.0,
	}),

	// The "monochrome" IBM CGA palette at high intensity.
	"cga5h": newPalData(2/3.0, []float32{
		0, 0, 0,
		1 / 3.0, 1, 1,
		1, 1 / 3.0, 1 / 3.0,
		1, 1, 1,
	}),

	// The original IBM EGA palette.
	"ega": newPalData(1/3.0, []float32{
		0, 0, 0,
		0, 0, 2 / 3.0,
		0, 2 / 3.0, 0,
		0, 2 / 3.0, 2 / 3.0,
		2 / 3.0, 0, 0,
		2 / 3.0, 0, 2 / 3.0,
		2 / 3.0, 1 / 3.0, 0,
		2 / 3.0, 2 / 3.0, 2 / 3.0,
		1 / 3.0, 1 / 3.0, 1 / 3.0,
		1 / 3.0, 1 / 3.0, 1,
		1 / 3.0, 1, 1 / 3.0,
		1 / 3.0, 1, 1,
		1, 1 / 3.0, 1 / 3.0,
		1, 1 / 3.0, 1,
		1, 1, 1 / 3.0,
		1, 1, 1,
	}),

	// The original IBM VGA palette.
	"vga": newPalData(5/63.0, []float32{
		0, 0, 0,
		0, 0, 2 / 3.0,
		0, 2 / 3.0, 0,
		0, 2 / 3.0, 2 / 3.0,
		2 / 3.0, 0, 0,
		2 / 3.0, 0, 2 / 3.0,
		2 / 3.0, 1 / 3.0, 0,
		2 / 3.0, 2 / 3.0, 2 / 3.0,
		1 / 3.0, 1 / 3.0, 1 / 3.0,
		1 / 3.0, 1 / 3.0, 1,
		1 / 3.0, 1, 1 / 3.0,
		1 / 3.0, 1, 1,
		1, 1 / 3.0, 1 / 3.0,
		1, 1 / 3.0, 1,
		1, 1, 1 / 3.0,
		1, 1, 1,
		// 0, 0, 0,                          // Redundant with color 0.
		5 / 63.0, 5 / 63.0, 5 / 63.0,
		8 / 63.0, 8 / 63.0, 8 / 63.0,
		11 / 63.0, 11 / 63.0, 11 / 63.0,
		2 / 9.0, 2 / 9.0, 2 / 9.0,
		// 17 / 63.0, 17 / 63.0, 17 / 63.0,  // Too close to color 8.
		// 20 / 63.0, 20 / 63.0, 20 / 63.0,  // Too close to color 8.
		// 8 / 21.0, 8 / 21.0, 8 / 21.0,     // Too close to color 8.
		4 / 9.0, 4 / 9.0, 4 / 9.0,
		32 / 63.0, 32 / 63.0, 32 / 63.0,
		// 4 / 7.0, 4 / 7.0, 4 / 7.0,        // Too close to color 7.
		// 40 / 63.0, 40 / 63.0, 40 / 63.0,  // Too close to color 7.
		// 5 / 7.0, 5 / 7.0, 5 / 7.0,        // Too close to color 7.
		50 / 63.0, 50 / 63.0, 50 / 63.0,
		8 / 9.0, 8 / 9.0, 8 / 9.0,
		// 1, 1, 1,                          // Redundant with color 15.
		0, 0, 1,
		16 / 63.0, 0, 1,
		31 / 63.0, 0, 1,
		47 / 63.0, 0, 1,
		1, 0, 1,
		1, 0, 47 / 63.0,
		1, 0, 31 / 63.0,
		1, 0, 16 / 63.0,
		1, 0, 0,
		1, 16 / 63.0, 0,
		1, 31 / 63.0, 0,
		1, 47 / 63.0, 0,
		1, 1, 0,
		47 / 63.0, 1, 0,
		31 / 63.0, 1, 0,
		16 / 63.0, 1, 0,
		0, 1, 0,
		0, 1, 16 / 63.0,
		0, 1, 31 / 63.0,
		0, 1, 47 / 63.0,
		0, 1, 1,
		0, 47 / 63.0, 1,
		0, 31 / 63.0, 1,
		0, 16 / 63.0, 1,
		31 / 63.0, 31 / 63.0, 1,
		13 / 21.0, 31 / 63.0, 1,
		47 / 63.0, 31 / 63.0, 1,
		55 / 63.0, 31 / 63.0, 1,
		1, 31 / 63.0, 1,
		1, 31 / 63.0, 55 / 63.0,
		1, 31 / 63.0, 47 / 63.0,
		1, 31 / 63.0, 13 / 21.0,
		1, 31 / 63.0, 31 / 63.0,
		1, 13 / 21.0, 31 / 63.0,
		1, 47 / 63.0, 31 / 63.0,
		1, 55 / 63.0, 31 / 63.0,
		1, 1, 31 / 63.0,
		55 / 63.0, 1, 31 / 63.0,
		47 / 63.0, 1, 31 / 63.0,
		13 / 21.0, 1, 31 / 63.0,
		31 / 63.0, 1, 31 / 63.0,
		31 / 63.0, 1, 13 / 21.0,
		31 / 63.0, 1, 47 / 63.0,
		31 / 63.0, 1, 55 / 63.0,
		31 / 63.0, 1, 1,
		31 / 63.0, 55 / 63.0, 1,
		31 / 63.0, 47 / 63.0, 1,
		31 / 63.0, 13 / 21.0, 1,
		5 / 7.0, 5 / 7.0, 1,
		7 / 9.0, 5 / 7.0, 1,
		6 / 7.0, 5 / 7.0, 1,
		58 / 63.0, 5 / 7.0, 1,
		1, 5 / 7.0, 1,
		1, 5 / 7.0, 58 / 63.0,
		1, 5 / 7.0, 6 / 7.0,
		1, 5 / 7.0, 7 / 9.0,
		1, 5 / 7.0, 5 / 7.0,
		1, 7 / 9.0, 5 / 7.0,
		1, 6 / 7.0, 5 / 7.0,
		1, 58 / 63.0, 5 / 7.0,
		1, 1, 5 / 7.0,
		58 / 63.0, 1, 5 / 7.0,
		6 / 7.0, 1, 5 / 7.0,
		7 / 9.0, 1, 5 / 7.0,
		5 / 7.0, 1, 5 / 7.0,
		5 / 7.0, 1, 7 / 9.0,
		5 / 7.0, 1, 6 / 7.0,
		5 / 7.0, 1, 58 / 63.0,
		5 / 7.0, 1, 1,
		5 / 7.0, 58 / 63.0, 1,
		5 / 7.0, 6 / 7.0, 1,
		5 / 7.0, 7 / 9.0, 1,
		0, 0, 4 / 9.0,
		1 / 9.0, 0, 4 / 9.0,
		2 / 9.0, 0, 4 / 9.0,
		1 / 3.0, 0, 4 / 9.0,
		4 / 9.0, 0, 4 / 9.0,
		4 / 9.0, 0, 1 / 3.0,
		4 / 9.0, 0, 2 / 9.0,
		4 / 9.0, 0, 1 / 9.0,
		4 / 9.0, 0, 0,
		4 / 9.0, 1 / 9.0, 0,
		4 / 9.0, 2 / 9.0, 0,
		4 / 9.0, 1 / 3.0, 0,
		4 / 9.0, 4 / 9.0, 0,
		1 / 3.0, 4 / 9.0, 0,
		2 / 9.0, 4 / 9.0, 0,
		1 / 9.0, 4 / 9.0, 0,
		0, 4 / 9.0, 0,
		0, 4 / 9.0, 1 / 9.0,
		0, 4 / 9.0, 2 / 9.0,
		0, 4 / 9.0, 1 / 3.0,
		0, 4 / 9.0, 4 / 9.0,
		0, 1 / 3.0, 4 / 9.0,
		0, 2 / 9.0, 4 / 9.0,
		0, 1 / 9.0, 4 / 9.0,
		2 / 9.0, 2 / 9.0, 4 / 9.0,
		17 / 63.0, 2 / 9.0, 4 / 9.0,
		1 / 3.0, 2 / 9.0, 4 / 9.0,
		8 / 21.0, 2 / 9.0, 4 / 9.0,
		4 / 9.0, 2 / 9.0, 4 / 9.0,
		4 / 9.0, 2 / 9.0, 8 / 21.0,
		4 / 9.0, 2 / 9.0, 1 / 3.0,
		4 / 9.0, 2 / 9.0, 17 / 63.0,
		4 / 9.0, 2 / 9.0, 2 / 9.0,
		4 / 9.0, 17 / 63.0, 2 / 9.0,
		4 / 9.0, 1 / 3.0, 2 / 9.0,
		4 / 9.0, 8 / 21.0, 2 / 9.0,
		4 / 9.0, 4 / 9.0, 2 / 9.0,
		8 / 21.0, 4 / 9.0, 2 / 9.0,
		1 / 3.0, 4 / 9.0, 2 / 9.0,
		17 / 63.0, 4 / 9.0, 2 / 9.0,
		2 / 9.0, 4 / 9.0, 2 / 9.0,
		2 / 9.0, 4 / 9.0, 17 / 63.0,
		2 / 9.0, 4 / 9.0, 1 / 3.0,
		2 / 9.0, 4 / 9.0, 8 / 21.0,
		2 / 9.0, 4 / 9.0, 4 / 9.0,
		2 / 9.0, 8 / 21.0, 4 / 9.0,
		2 / 9.0, 1 / 3.0, 4 / 9.0,
		2 / 9.0, 17 / 63.0, 4 / 9.0,
		20 / 63.0, 20 / 63.0, 4 / 9.0,
		22 / 63.0, 20 / 63.0, 4 / 9.0,
		8 / 21.0, 20 / 63.0, 4 / 9.0,
		26 / 63.0, 20 / 63.0, 4 / 9.0,
		4 / 9.0, 20 / 63.0, 4 / 9.0,
		4 / 9.0, 20 / 63.0, 26 / 63.0,
		4 / 9.0, 20 / 63.0, 8 / 21.0,
		4 / 9.0, 20 / 63.0, 22 / 63.0,
		4 / 9.0, 20 / 63.0, 20 / 63.0,
		4 / 9.0, 22 / 63.0, 20 / 63.0,
		4 / 9.0, 8 / 21.0, 20 / 63.0,
		4 / 9.0, 26 / 63.0, 20 / 63.0,
		4 / 9.0, 4 / 9.0, 20 / 63.0,
		26 / 63.0, 4 / 9.0, 20 / 63.0,
		8 / 21.0, 4 / 9.0, 20 / 63.0,
		22 / 63.0, 4 / 9.0, 20 / 63.0,
		20 / 63.0, 4 / 9.0, 20 / 63.0,
		20 / 63.0, 4 / 9.0, 22 / 63.0,
		20 / 63.0, 4 / 9.0, 8 / 21.0,
		20 / 63.0, 4 / 9.0, 26 / 63.0,
		20 / 63.0, 4 / 9.0, 4 / 9.0,
		20 / 63.0, 26 / 63.0, 4 / 9.0,
		20 / 63.0, 8 / 21.0, 4 / 9.0,
		20 / 63.0, 22 / 63.0, 4 / 9.0,
		0, 0, 16 / 63.0,
		4 / 63.0, 0, 16 / 63.0,
		8 / 63.0, 0, 16 / 63.0,
		4 / 21.0, 0, 16 / 63.0,
		16 / 63.0, 0, 16 / 63.0,
		16 / 63.0, 0, 4 / 21.0,
		16 / 63.0, 0, 8 / 63.0,
		16 / 63.0, 0, 4 / 63.0,
		16 / 63.0, 0, 0,
		16 / 63.0, 4 / 63.0, 0,
		16 / 63.0, 8 / 63.0, 0,
		16 / 63.0, 4 / 21.0, 0,
		16 / 63.0, 16 / 63.0, 0,
		4 / 21.0, 16 / 63.0, 0,
		8 / 63.0, 16 / 63.0, 0,
		4 / 63.0, 16 / 63.0, 0,
		0, 16 / 63.0, 0,
		0, 16 / 63.0, 4 / 63.0,
		0, 16 / 63.0, 8 / 63.0,
		0, 16 / 63.0, 4 / 21.0,
		0, 16 / 63.0, 16 / 63.0,
		0, 4 / 21.0, 16 / 63.0,
		0, 8 / 63.0, 16 / 63.0,
		0, 4 / 63.0, 16 / 63.0,
		8 / 63.0, 8 / 63.0, 16 / 63.0,
		10 / 63.0, 8 / 63.0, 16 / 63.0,
		4 / 21.0, 8 / 63.0, 16 / 63.0,
		2 / 9.0, 8 / 63.0, 16 / 63.0,
		16 / 63.0, 8 / 63.0, 16 / 63.0,
		16 / 63.0, 8 / 63.0, 2 / 9.0,
		16 / 63.0, 8 / 63.0, 4 / 21.0,
		16 / 63.0, 8 / 63.0, 10 / 63.0,
		16 / 63.0, 8 / 63.0, 8 / 63.0,
		16 / 63.0, 10 / 63.0, 8 / 63.0,
		16 / 63.0, 4 / 21.0, 8 / 63.0,
		16 / 63.0, 2 / 9.0, 8 / 63.0,
		16 / 63.0, 16 / 63.0, 8 / 63.0,
		2 / 9.0, 16 / 63.0, 8 / 63.0,
		4 / 21.0, 16 / 63.0, 8 / 63.0,
		10 / 63.0, 16 / 63.0, 8 / 63.0,
		8 / 63.0, 16 / 63.0, 8 / 63.0,
		8 / 63.0, 16 / 63.0, 10 / 63.0,
		8 / 63.0, 16 / 63.0, 4 / 21.0,
		8 / 63.0, 16 / 63.0, 2 / 9.0,
		8 / 63.0, 16 / 63.0, 16 / 63.0,
		8 / 63.0, 2 / 9.0, 16 / 63.0,
		8 / 63.0, 4 / 21.0, 16 / 63.0,
		8 / 63.0, 10 / 63.0, 16 / 63.0,
		11 / 63.0, 11 / 63.0, 16 / 63.0,
		4 / 21.0, 11 / 63.0, 16 / 63.0,
		13 / 63.0, 11 / 63.0, 16 / 63.0,
		5 / 21.0, 11 / 63.0, 16 / 63.0,
		16 / 63.0, 11 / 63.0, 16 / 63.0,
		16 / 63.0, 11 / 63.0, 5 / 21.0,
		16 / 63.0, 11 / 63.0, 13 / 63.0,
		16 / 63.0, 11 / 63.0, 4 / 21.0,
		16 / 63.0, 11 / 63.0, 11 / 63.0,
		16 / 63.0, 4 / 21.0, 11 / 63.0,
		16 / 63.0, 13 / 63.0, 11 / 63.0,
		16 / 63.0, 5 / 21.0, 11 / 63.0,
		16 / 63.0, 16 / 63.0, 11 / 63.0,
		5 / 21.0, 16 / 63.0, 11 / 63.0,
		13 / 63.0, 16 / 63.0, 11 / 63.0,
		4 / 21.0, 16 / 63.0, 11 / 63.0,
		11 / 63.0, 16 / 63.0, 11 / 63.0,
		11 / 63.0, 16 / 63.0, 4 / 21.0,
		11 / 63.0, 16 / 63.0, 13 / 63.0,
		11 / 63.0, 16 / 63.0, 5 / 21.0,
		11 / 63.0, 16 / 63.0, 16 / 63.0,
		11 / 63.0, 5 / 21.0, 16 / 63.0,
		11 / 63.0, 13 / 63.0, 16 / 63.0,
		11 / 63.0, 4 / 21.0, 16 / 63.0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
		// 0, 0, 0,
	}),
}
